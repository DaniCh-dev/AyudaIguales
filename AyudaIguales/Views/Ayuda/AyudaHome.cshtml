@model List<AyudaIguales.Models.Ayuda>
@{
    ViewData["Title"] = "Ayudas";
    var userRole = Context.Session.GetString("UserRole");
}

<div class="container-fluid">
    <div class="row">
        <!-- CONTENIDO PRINCIPAL - Listado de ayudas -->
        <div class="col-lg-9">
            <!-- Cabecera con título y botón crear ayuda -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-question-circle-fill text-primary"></i>
                    Ayudas Recientes
                </h2>
                <a asp-controller="Ayuda" asp-action="CrearAyuda" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i>
                    Nueva Ayuda
                </a>
            </div>

            <!-- Mostrar mensajes de éxito/error -->
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Buscador principal -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form asp-controller="Ayuda" asp-action="AyudaHome" method="get">
                        <!-- AÑADIR ESTE CAMPO OCULTO -->
                        <input type="hidden" name="id_centro" value="@Context.Session.GetString("CentroId")" />

                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text"
                                   name="busqueda"
                                   class="form-control border-start-0"
                                   placeholder="Buscar por título o contenido..."
                                   value="@ViewBag.BusquedaActual">

                            <!-- Mantener filtros actuales en campos ocultos -->
                            <input type="hidden" name="estado" value="@ViewBag.EstadoActual" />
                            <input type="hidden" name="id_usuario" value="@ViewBag.UsuarioActual" />
                            <input type="hidden" name="fecha" value="@ViewBag.FechaActual" />
                            <input type="hidden" name="respuestas" value="@ViewBag.RespuestasActual" />

                            <button class="btn btn-primary" type="submit">
                                Buscar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Listado de ayudas -->
            <div id="listadoAyudas">
                @if (Model != null && Model.Count > 0)
                {
                    @foreach (var ayuda in Model)
                    {
                        <div class="card shadow-sm mb-3 hover-shadow" style="cursor: pointer;"
                             onclick="location.href='@Url.Action("DetalleAyuda", "Ayuda", new { id = ayuda.id })'">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0 text-dark">
                                        @ayuda.descripcion
                                    </h5>
                                    <div class="d-flex gap-2 align-items-center">
                                        @if (ayuda.activa)
                                        {
                                            <span class="badge bg-success">Activa</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactiva</span>
                                        }

                                        <!-- Botones de admin (solo visible para administradores) -->
                                        @if (userRole == "admin")
                                        {
                                            <div class="btn-group" role="group" onclick="event.stopPropagation();">
                                                <!-- Boton para cambiar estado -->
                                                <form asp-controller="Ayuda" asp-action="CambiarEstado" method="post" class="d-inline">
                                                    <input type="hidden" name="id" value="@ayuda.id" />
                                                    <button type="submit" class="btn btn-sm btn-warning" title="@(ayuda.activa ? "Desactivar" : "Activar")">
                                                        <i class="bi bi-@(ayuda.activa ? "pause" : "play")-circle"></i>
                                                    </button>
                                                </form>

                                                <!-- Boton para eliminar -->
                                                <form asp-controller="Ayuda" asp-action="Eliminar" method="post" class="d-inline"
                                                      onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta ayuda? Esta acción no se puede deshacer.');">
                                                    <input type="hidden" name="id" value="@ayuda.id" />
                                                    <button type="submit" class="btn btn-sm btn-danger" title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <p class="card-text text-muted mb-2">
                                    @(ayuda.contenido.Length > 150 ? ayuda.contenido.Substring(0, 150) + "..." : ayuda.contenido)
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted small">
                                        <i class="bi bi-person-fill"></i> @ayuda.nombre_usuario
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-calendar-fill"></i> @ayuda.fecha.ToString("dd/MM/yyyy HH:mm")
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-chat-fill"></i> @ayuda.num_respuestas respuestas
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <p class="mt-3 text-muted">No se encontraron ayudas con los filtros aplicados</p>
                    </div>
                }
            </div>
        </div>

        <!-- SIDEBAR DERECHA - Filtros -->
        <div class="col-lg-3">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel-fill"></i>
                        Filtros
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-controller="Ayuda" asp-action="AyudaHome" method="get">

                        <!-- CAMPO OCULTO -->
                        <input type="hidden" name="id_centro" value="@Context.Session.GetString("CentroId")" />

                        <!-- Mantener búsqueda actual -->
                        <input type="hidden" name="busqueda" value="@ViewBag.BusquedaActual" />

                        <!-- Filtro por estado -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-toggle-on"></i>
                                Estado
                            </label>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="estado"
                                       id="estadoTodas"
                                       value=""
                                       @(string.IsNullOrEmpty(ViewBag.EstadoActual) ? "checked" : "")>
                                <label class="form-check-label" for="estadoTodas">
                                    Todas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="estado"
                                       id="estadoActivas"
                                       value="1"
                                       @(ViewBag.EstadoActual == "1" ? "checked" : "")>
                                <label class="form-check-label" for="estadoActivas">
                                    Activas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="estado"
                                       id="estadoInactivas"
                                       value="0"
                                       @(ViewBag.EstadoActual == "0" ? "checked" : "")>
                                <label class="form-check-label" for="estadoInactivas">
                                    Inactivas
                                </label>
                            </div>
                        </div>

                        <!-- Filtro por usuario (solo para admin) -->
                        @if (userRole == "admin")
                        {
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-person-fill"></i>
                                    Usuario
                                </label>
                                <select class="form-select" name="id_usuario">
                                    <option value="">Todos los usuarios</option>
                                    @if (ViewBag.Usuarios != null)
                                    {
                                        foreach (var usuario in ViewBag.Usuarios)
                                        {
                                            var isSelected = ViewBag.UsuarioActual != null && ViewBag.UsuarioActual == usuario.id;
                                            <option value="@usuario.id" selected="@isSelected">
                                                @usuario.nombre_usuario
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                        }

                        <!-- Filtro por fecha -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar-fill"></i>
                                Fecha
                            </label>
                            <select class="form-select" name="fecha">
                                <option value="" selected="@(string.IsNullOrEmpty(ViewBag.FechaActual))">Todas las fechas</option>
                                <option value="hoy" selected="@(ViewBag.FechaActual == "hoy")">Hoy</option>
                                <option value="semana" selected="@(ViewBag.FechaActual == "semana")">Esta semana</option>
                                <option value="mes" selected="@(ViewBag.FechaActual == "mes")">Este mes</option>
                            </select>
                        </div>

                        <!-- Filtro por respuestas -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-chat-dots-fill"></i>
                                Respuestas
                            </label>
                            <select class="form-select" name="respuestas">
                                <option value="" selected="@(string.IsNullOrEmpty(ViewBag.RespuestasActual))">Todas</option>
                                <option value="sin_respuestas" selected="@(ViewBag.RespuestasActual == "sin_respuestas")">Sin respuestas</option>
                                <option value="con_respuestas" selected="@(ViewBag.RespuestasActual == "con_respuestas")">Con respuestas</option>
                            </select>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i>
                                Aplicar filtros
                            </button>
                            <a asp-controller="Ayuda" asp-action="AyudaHome" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i>
                                Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        /* Efecto hover en las tarjetas */
        .hover-shadow {
            transition: all 0.3s ease;
        }

            .hover-shadow:hover {
                transform: translateY(-5px);
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
            }

        /* Estilos para el sidebar sticky */
        .sticky-top {
            z-index: 1020;
        }

        /* Estilos para los botones de admin */
        .btn-group .btn {
            border-radius: 0.25rem;
        }

            .btn-group .btn:not(:last-child) {
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
            }

            .btn-group .btn:not(:first-child) {
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
                margin-left: -1px;
            }
    </style>
}