@model Ayuda
@using AyudaIguales.Models
@{
    ViewData["Title"] = "Detalle de Ayuda";
    var apiUrl = "http://localhost/ayuda_iguales/";
    var userRole = Context.Session.GetString("UserRole");

    // Obtener las respuestas del ViewBag
    var respuestas = ViewBag.Respuestas as List<RespuestaDetalle> ?? new List<RespuestaDetalle>();
    var cantidadRespuestas = ViewBag.CantidadRespuestas ?? 0;
}

<div class="container mt-4">
    <!-- Contenedor principal de la ayuda -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">@Model.descripcion</h5>
            <small class="text-muted">@Model.fecha.ToString("dd/MM/yyyy HH:mm")</small>
        </div>
        <div class="card-body">
            <!-- Informacion del usuario que publico la ayuda -->
            <p class="mb-2"><strong>Publicado por:</strong> @Model.nombre_usuario</p>

            <!-- Contenido completo de la ayuda -->
            <p class="mt-3">@Model.contenido</p>

            <!-- Imagenes adjuntas a la ayuda si existen -->
            @if (Model.imagenes != null && Model.imagenes.Any())
            {
                <div class="mt-3">
                    <h6>Imágenes adjuntas:</h6>
                    <div class="row">
                        @foreach (var imagen in Model.imagenes)
                        {
                            <div class="col-md-4 mb-2">
                                <img src="@(apiUrl + imagen)" class="img-fluid rounded" alt="Imagen ayuda" />
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="card-footer">
            <!-- Boton para responder solo si la ayuda esta activa -->
            @if (Model.activa)
            {
                <a href="@Url.Action("Responder", "Ayuda", new { id = Model.id })" class="btn btn-primary">
                    Responder
                </a>
            }
            else
            {
                <button class="btn btn-secondary" disabled>
                    <i class="bi bi-lock-fill"></i> Ayuda desactivada
                </button>
            }
            <a href="@Url.Action("AyudaHome", "Ayuda")" class="btn btn-secondary">
                Volver al listado
            </a>
        </div>
    </div>

    <!-- Seccion de respuestas -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Respuestas (@cantidadRespuestas)</h5>
        </div>
        <div class="card-body">
            @if (respuestas != null && respuestas.Count > 0)
            {
                <!-- Listar todas las respuestas -->
                @foreach (var respuesta in respuestas)
                {
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <!-- Usuario que respondio y fecha -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <p class="mb-0">
                                        <strong>@respuesta.nombre_usuario</strong>
                                        <small class="text-muted ms-2">@respuesta.fecha.ToString("dd/MM/yyyy HH:mm")</small>
                                    </p>

                                    <!-- Boton de eliminar para admin -->
                                    @if (userRole == "admin")
                                    {
                                        <form asp-controller="Ayuda" asp-action="EliminarRespuesta" method="post" class="d-inline"
                                              onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta respuesta? Esta acción no se puede deshacer.');">
                                            <input type="hidden" name="id" value="@respuesta.id" />
                                            <input type="hidden" name="id_ayuda" value="@Model.id" />
                                            <button type="submit" class="btn btn-sm btn-danger" title="Eliminar respuesta">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    }
                                </div>

                                <!-- Contenido de la respuesta -->
                                <p class="mt-2">@respuesta.contenido</p>

                                <!-- Imagenes adjuntas a la respuesta si existen -->
                                @if (respuesta.imagenes != null && respuesta.imagenes.Count > 0)
                                {
                                    <div class="mt-2">
                                        <div class="row">
                                            @foreach (var imagen in respuesta.imagenes)
                                            {
                                                <div class="col-md-3 mb-2">
                                                    <img src="@(apiUrl + imagen)" class="img-fluid rounded" alt="Imagen respuesta" />
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Sistema de valoracion -->
                            <div class="ms-3 text-center">
                                <div class="btn-group-vertical" role="group">
                                    <!-- Mostrar valoracion promedio si existe -->
                                    @if (respuesta.nota_promedio > 0)
                                    {
                                        <span class="badge bg-warning text-dark mb-2">
                                            ⭐ @respuesta.nota_promedio.ToString("F1")
                                        </span>
                                    }

                                    <!-- Formulario para valorar la respuesta -->
                                    @if (respuesta.puede_valorar)
                                    {
                                        <form asp-controller="Valoracion" asp-action="Crear" method="post" class="d-inline">
                                            <input type="hidden" name="id_respuesta" value="@respuesta.id" />
                                            <input type="hidden" name="id_ayuda" value="@Model.id" />

                                            <!-- Selector de nota del 1 al 5 -->
                                            <select name="nota" class="form-select form-select-sm mb-1" required>
                                                <option value="">Valorar</option>
                                                <option value="1">1 ⭐</option>
                                                <option value="2">2 ⭐</option>
                                                <option value="3">3 ⭐</option>
                                                <option value="4">4 ⭐</option>
                                                <option value="5">5 ⭐</option>
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                Enviar
                                            </button>
                                        </form>
                                    }
                                    else if (respuesta.ya_valorado)
                                    {
                                        <span class="badge bg-secondary">Ya valorado</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Mensaje cuando no hay respuestas -->
                <p class="text-muted text-center">Aún no hay respuestas para esta ayuda. ¡Sé el primero en responder!</p>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Script para mostrar mensaje de exito o error si existe
        @if (TempData["Success"] != null)
        {
                <text>
                alert('@TempData["Success"]');
                </text>
        }
        @if (TempData["Error"] != null)
        {
                <text>
                alert('@TempData["Error"]');
                </text>
        }
    </script>
}